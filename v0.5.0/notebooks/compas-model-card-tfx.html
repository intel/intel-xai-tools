<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detecting Issues in Fairness by Generate Model Card from Tensorflow Estimators &mdash; Intel® Explainable AI Tools 0.5.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" type="text/css" />
      <link rel="stylesheet" href="../_static/nbsphinx-code-cells.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/design-tabs.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Intel® Explainable AI Tools
          </a>
              <div class="version">
                0.5.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explainer/index.html">Explainer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../model_card_gen/index.html">Model Card Generator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks.html">Example Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../legal.html">Legal Information</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/IntelAI/intel-xai-tools">GitHub Repository</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Intel® Explainable AI Tools</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Detecting Issues in Fairness by Generate Model Card from Tensorflow Estimators</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/notebooks/compas-model-card-tfx.nblink.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Detecting-Issues-in-Fairness-by-Generate-Model-Card-from-Tensorflow-Estimators">
<h1>Detecting Issues in Fairness by Generate Model Card from Tensorflow Estimators<a class="headerlink" href="#Detecting-Issues-in-Fairness-by-Generate-Model-Card-from-Tensorflow-Estimators" title="Permalink to this heading"></a></h1>
<p>In this notebook we will create a TFX pipeline to create a Proxy model for COMPAS (originally published by <a class="reference external" href="https://github.com/tensorflow/fairness-indicators/blob/r0.38.0/g3doc/tutorials/Fairness_Indicators_Lineage_Case_Study.ipynb">Tensorflow Authors</a>). First, we will train a <code class="docutils literal notranslate"><span class="pre">tf.estimator</span></code> with defined <code class="docutils literal notranslate"><span class="pre">eval_input_reciever_fn</span></code>. This will allow us to run userdefined metrics with <code class="docutils literal notranslate"><span class="pre">tensorflow-model-analysis</span></code> on seralized <code class="docutils literal notranslate"><span class="pre">tf.Example</span></code>.</p>
<p>After this pipeline has be created, we will show how Intel’s <code class="docutils literal notranslate"><span class="pre">ModelCardGen</span></code> class can take this <code class="docutils literal notranslate"><span class="pre">tf.estimator</span></code> in the form of an SavedModel and TFRecord to create a Model Card with interactive graphics.</p>
<section id="Install-Dependencies">
<h2>Install Dependencies<a class="headerlink" href="#Install-Dependencies" title="Permalink to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!python -m pip install -U \
  tfx \
  tensorflow-model-analysis \
  tensorflow-transform \
  scikit-learn \
  pandas
</pre></div>
</div>
</div>
</section>
<section id="Import-Libraries">
<h2>Import Libraries<a class="headerlink" href="#Import-Libraries" title="Permalink to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="c1"># Intel Model Card Genorator</span>
<span class="kn">from</span> <span class="nn">model_card_gen.model_card_gen</span> <span class="kn">import</span> <span class="n">ModelCardGen</span>
<span class="kn">from</span> <span class="nn">model_card_gen.datasets</span> <span class="kn">import</span> <span class="n">TensorflowDataset</span>
</pre></div>
</div>
</div>
<section id="Download-and-preprocess-the-dataset">
<h3>Download and preprocess the dataset<a class="headerlink" href="#Download-and-preprocess-the-dataset" title="Permalink to this heading"></a></h3>
<p>The COMPAS dataset is a common case study in the ML fairness literature1, 2, 3, where it is use to apply techniques for identifying and remediating issues around fairness. ___</p>
<ol class="arabic simple">
<li><p>Wadsworth, C., Vera, F., Piech, C. (2017). Achieving Fairness Through Adversarial Learning: an Application to Recidivism Prediction. <a class="reference external" href="https://arxiv.org/abs/1807.00199">https://arxiv.org/abs/1807.00199</a>.</p></li>
<li><p>Chouldechova, A., G’Sell, M., (2017). Fairer and more accurate, but for whom? <a class="reference external" href="https://arxiv.org/abs/1707.00046">https://arxiv.org/abs/1707.00046</a>.</p></li>
<li><p>Berk et al., (2017), Fairness in Criminal Justice Risk Assessments: The State of the Art, <a class="reference external" href="https://arxiv.org/abs/1703.09207">https://arxiv.org/abs/1703.09207</a>.</p></li>
</ol>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>mkdir<span class="w"> </span>-p<span class="w"> </span>compas/data/<span class="o">{</span>train,eval<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Download the COMPAS dataset and setup the required filepaths.</span>
<span class="n">_DATA_ROOT</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;tfx-data&#39;</span><span class="p">)</span>
<span class="n">_DATA_PATH</span> <span class="o">=</span> <span class="s1">&#39;https://storage.googleapis.com/compas_dataset/cox-violent-parsed.csv&#39;</span>
<span class="n">_DATA_FILEPATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;compas&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span>

<span class="n">_COMPAS_DF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">_DATA_PATH</span><span class="p">)</span>

<span class="c1"># To simpliy the case study, we will only use the columns that will be used for</span>
<span class="c1"># our model.</span>
<span class="n">_COLUMN_NAMES</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">&#39;age&#39;</span><span class="p">,</span>
  <span class="s1">&#39;c_charge_desc&#39;</span><span class="p">,</span>
  <span class="s1">&#39;c_charge_degree&#39;</span><span class="p">,</span>
  <span class="s1">&#39;c_days_from_compas&#39;</span><span class="p">,</span>
  <span class="s1">&#39;is_recid&#39;</span><span class="p">,</span>            <span class="c1"># ground truth</span>
  <span class="s1">&#39;juv_fel_count&#39;</span><span class="p">,</span>
  <span class="s1">&#39;juv_misd_count&#39;</span><span class="p">,</span>
  <span class="s1">&#39;juv_other_count&#39;</span><span class="p">,</span>
  <span class="s1">&#39;priors_count&#39;</span><span class="p">,</span>
  <span class="s1">&#39;r_days_from_arrest&#39;</span><span class="p">,</span>
  <span class="s1">&#39;race&#39;</span><span class="p">,</span>
  <span class="s1">&#39;sex&#39;</span><span class="p">,</span>
  <span class="s1">&#39;vr_charge_desc&#39;</span><span class="p">,</span>
  <span class="s1">&#39;score_text&#39;</span><span class="p">,</span>          <span class="c1"># COMPAS predction</span>
<span class="p">]</span>

<span class="n">_GROUND_TRUTH</span> <span class="o">=</span> <span class="s1">&#39;is_recid&#39;</span>
<span class="n">_COMPAS_SCORE</span> <span class="o">=</span> <span class="s1">&#39;score_text&#39;</span>

<span class="n">_COMPAS_DF</span> <span class="o">=</span> <span class="n">_COMPAS_DF</span><span class="p">[</span><span class="n">_COLUMN_NAMES</span><span class="p">]</span>

<span class="c1"># We will use &#39;is_recid&#39; as our ground truth lable, which is boolean value</span>
<span class="c1"># indicating if a defendant committed another crime. There are some rows with -1</span>
<span class="c1"># indicating that there is no data. These rows we will drop from training.</span>
<span class="n">_COMPAS_DF</span> <span class="o">=</span> <span class="n">_COMPAS_DF</span><span class="p">[</span><span class="n">_COMPAS_DF</span><span class="p">[</span><span class="s1">&#39;is_recid&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">_COMPAS_DF</span> <span class="o">=</span> <span class="n">_COMPAS_DF</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;score_text&#39;</span><span class="p">])</span>
<span class="n">_COMPAS_DF</span><span class="p">[</span><span class="s1">&#39;score_text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_COMPAS_DF</span><span class="o">.</span><span class="n">score_text</span><span class="o">.</span><span class="n">map</span><span class="p">({</span><span class="s1">&#39;Low&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;High&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Medium&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="c1"># is_recid field is ground truth to create a COMPAS proxy we will need to train on score_text</span>
<span class="c1"># _COMPAS_DF = _COMPAS_DF.rename(columns={&#39;is_recid&#39;: &#39;ground_truth&#39;, &#39;score_text&#39;: &#39;compas_score&#39;})</span>

<span class="c1"># Given the distribution between races in this dataset we will only focuse on</span>
<span class="c1"># recidivism for African-Americans and Caucasians.</span>
<span class="n">_COMPAS_DF</span> <span class="o">=</span> <span class="n">_COMPAS_DF</span><span class="p">[</span>
  <span class="n">_COMPAS_DF</span><span class="p">[</span><span class="s1">&#39;race&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;African-American&#39;</span><span class="p">,</span> <span class="s1">&#39;Caucasian&#39;</span><span class="p">])]</span>

<span class="n">X</span>  <span class="o">=</span> <span class="n">_COMPAS_DF</span><span class="p">[</span><span class="n">_COLUMN_NAMES</span><span class="p">]</span>
<span class="c1"># to create a COMPAS proxy we will need to train on score_text not to be confused with ground truth is_recid field</span>
<span class="c1"># y = _COMPAS_DF[[_COMPAS_SCORE]]</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.33</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Load the DataFrame back to a CSV file for our TFX model.</span>
<span class="n">X_train</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_DATA_FILEPATH</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;train.csv&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">na_rep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">X_test</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_DATA_FILEPATH</span><span class="p">,</span> <span class="s1">&#39;eval&#39;</span><span class="p">,</span> <span class="s1">&#39;eval.csv&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">na_rep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
</section>
</section>
<section id="TFX-Pipeline-Scripts">
<h1>TFX Pipeline Scripts<a class="headerlink" href="#TFX-Pipeline-Scripts" title="Permalink to this heading"></a></h1>
<p>We opt to create a custom pipeline script so that we can transform data and train a model saved as artifacts to use in as input in Model Card Generator.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_transformer_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;compas&#39;</span><span class="p">,</span> <span class="s1">&#39;transformer.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> {_transformer_path}
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow_transform</span> <span class="k">as</span> <span class="nn">tft</span>

<span class="n">CATEGORICAL_FEATURE_KEYS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;sex&#39;</span><span class="p">,</span>
    <span class="s1">&#39;race&#39;</span><span class="p">,</span>
    <span class="s1">&#39;c_charge_desc&#39;</span><span class="p">,</span>
    <span class="s1">&#39;c_charge_degree&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">INT_FEATURE_KEYS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;age&#39;</span><span class="p">,</span>
    <span class="s1">&#39;c_days_from_compas&#39;</span><span class="p">,</span>
    <span class="s1">&#39;juv_fel_count&#39;</span><span class="p">,</span>
    <span class="s1">&#39;juv_misd_count&#39;</span><span class="p">,</span>
    <span class="s1">&#39;juv_other_count&#39;</span><span class="p">,</span>
    <span class="s1">&#39;priors_count&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">LABEL_KEY</span> <span class="o">=</span> <span class="s1">&#39;is_recid&#39;</span>

<span class="c1"># List of the unique values for the items within CATEGORICAL_FEATURE_KEYS.</span>
<span class="n">MAX_CATEGORICAL_FEATURE_VALUES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">513</span><span class="p">,</span>
    <span class="mi">14</span><span class="p">,</span>
<span class="p">]</span>


<span class="k">def</span> <span class="nf">transformed_name</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
  <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_xf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">preprocessing_fn</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;tf.transform&#39;s callback function for preprocessing inputs.</span>

<span class="sd">  Args:</span>
<span class="sd">    inputs: Map from feature keys to raw features.</span>

<span class="sd">  Returns:</span>
<span class="sd">    Map from string feature key to transformed feature operations.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">CATEGORICAL_FEATURE_KEYS</span><span class="p">:</span>
    <span class="n">outputs</span><span class="p">[</span><span class="n">transformed_name</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tft</span><span class="o">.</span><span class="n">compute_and_apply_vocabulary</span><span class="p">(</span>
        <span class="n">_fill_in_missing</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">]),</span>
        <span class="n">vocab_filename</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">INT_FEATURE_KEYS</span><span class="p">:</span>
    <span class="n">outputs</span><span class="p">[</span><span class="n">transformed_name</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tft</span><span class="o">.</span><span class="n">scale_to_z_score</span><span class="p">(</span>
        <span class="n">_fill_in_missing</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>

  <span class="c1"># Target label will be to see if the defendant is charged for another crime.</span>
  <span class="n">outputs</span><span class="p">[</span><span class="n">transformed_name</span><span class="p">(</span><span class="n">LABEL_KEY</span><span class="p">)]</span> <span class="o">=</span> <span class="n">_fill_in_missing</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">LABEL_KEY</span><span class="p">])</span>
  <span class="k">return</span> <span class="n">outputs</span>


<span class="k">def</span> <span class="nf">_fill_in_missing</span><span class="p">(</span><span class="n">tensor_value</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Replaces a missing values in a SparseTensor.</span>

<span class="sd">  Fills in missing values of `tensor_value` with &#39;&#39; or 0, and converts to a</span>
<span class="sd">  dense tensor.</span>

<span class="sd">  Args:</span>
<span class="sd">    tensor_value: A `SparseTensor` of rank 2. Its dense shape should have size</span>
<span class="sd">      at most 1 in the second dimension.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A rank 1 tensor where missing values of `tensor_value` are filled in.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tensor_value</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">SparseTensor</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tensor_value</span>
  <span class="n">default_value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">tensor_value</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">tf</span><span class="o">.</span><span class="n">string</span> <span class="k">else</span> <span class="mi">0</span>
  <span class="n">sparse_tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">SparseTensor</span><span class="p">(</span>
      <span class="n">tensor_value</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span>
      <span class="n">tensor_value</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
      <span class="p">[</span><span class="n">tensor_value</span><span class="o">.</span><span class="n">dense_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span>
  <span class="n">dense_tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">to_dense</span><span class="p">(</span><span class="n">sparse_tensor</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dense_tensor</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_trainer_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;compas&#39;</span><span class="p">,</span> <span class="s1">&#39;trainer.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> {_trainer_path}

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow_model_analysis</span> <span class="k">as</span> <span class="nn">tfma</span>
<span class="kn">import</span> <span class="nn">tensorflow_transform</span> <span class="k">as</span> <span class="nn">tft</span>
<span class="kn">from</span> <span class="nn">tensorflow_transform.tf_metadata</span> <span class="kn">import</span> <span class="n">schema_utils</span>

<span class="kn">from</span> <span class="nn">transformer</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">_BATCH_SIZE</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">_LEARNING_RATE</span> <span class="o">=</span> <span class="mf">0.00001</span>
<span class="n">_MAX_CHECKPOINTS</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">_SAVE_CHECKPOINT_STEPS</span> <span class="o">=</span> <span class="mi">999</span>


<span class="k">def</span> <span class="nf">transformed_names</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
  <span class="k">return</span> <span class="p">[</span><span class="n">transformed_name</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">transformed_name</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
  <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_xf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_gzip_reader_fn</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns a record reader that can read gzip&#39;ed files.</span>

<span class="sd">  Args:</span>
<span class="sd">    filenames: A tf.string tensor or tf.data.Dataset containing one or more</span>
<span class="sd">      filenames.</span>

<span class="sd">  Returns: A nested structure of tf.TypeSpec objects matching the structure of</span>
<span class="sd">    an element of this dataset and specifying the type of individual components.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TFRecordDataset</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="n">compression_type</span><span class="o">=</span><span class="s1">&#39;GZIP&#39;</span><span class="p">)</span>


<span class="c1"># Tf.Transform considers these features as &quot;raw&quot;.</span>
<span class="k">def</span> <span class="nf">_get_raw_feature_spec</span><span class="p">(</span><span class="n">schema</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Generates a feature spec from a Schema proto.</span>

<span class="sd">  Args:</span>
<span class="sd">    schema: A Schema proto.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A feature spec defined as a dict whose keys are feature names and values are</span>
<span class="sd">      instances of FixedLenFeature, VarLenFeature or SparseFeature.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">schema_utils</span><span class="o">.</span><span class="n">schema_as_feature_spec</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span><span class="o">.</span><span class="n">feature_spec</span>


<span class="k">def</span> <span class="nf">_example_serving_receiver_fn</span><span class="p">(</span><span class="n">tf_transform_output</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Builds the serving in inputs.</span>

<span class="sd">  Args:</span>
<span class="sd">    tf_transform_output: A TFTransformOutput.</span>
<span class="sd">    schema: the schema of the input data.</span>

<span class="sd">  Returns:</span>
<span class="sd">    TensorFlow graph which parses examples, applying tf-transform to them.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">raw_feature_spec</span> <span class="o">=</span> <span class="n">_get_raw_feature_spec</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
  <span class="n">raw_feature_spec</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">LABEL_KEY</span><span class="p">)</span>

  <span class="n">raw_input_fn</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">export</span><span class="o">.</span><span class="n">build_parsing_serving_input_receiver_fn</span><span class="p">(</span>
      <span class="n">raw_feature_spec</span><span class="p">)</span>
  <span class="n">serving_input_receiver</span> <span class="o">=</span> <span class="n">raw_input_fn</span><span class="p">()</span>

  <span class="n">transformed_features</span> <span class="o">=</span> <span class="n">tf_transform_output</span><span class="o">.</span><span class="n">transform_raw_features</span><span class="p">(</span>
      <span class="n">serving_input_receiver</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
  <span class="n">transformed_features</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">transformed_name</span><span class="p">(</span><span class="n">LABEL_KEY</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">export</span><span class="o">.</span><span class="n">ServingInputReceiver</span><span class="p">(</span>
      <span class="n">transformed_features</span><span class="p">,</span> <span class="n">serving_input_receiver</span><span class="o">.</span><span class="n">receiver_tensors</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_eval_input_receiver_fn</span><span class="p">(</span><span class="n">tf_transform_output</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Builds everything needed for the tf-model-analysis to run the model.</span>

<span class="sd">  Args:</span>
<span class="sd">    tf_transform_output: A TFTransformOutput.</span>
<span class="sd">    schema: the schema of the input data.</span>

<span class="sd">  Returns:</span>
<span class="sd">    EvalInputReceiver function, which contains:</span>
<span class="sd">      - TensorFlow graph which parses raw untransformed features, applies the</span>
<span class="sd">          tf-transform preprocessing operators.</span>
<span class="sd">      - Set of raw, untransformed features.</span>
<span class="sd">      - Label against which predictions will be compared.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1"># Notice that the inputs are raw features, not transformed features here.</span>
  <span class="n">raw_feature_spec</span> <span class="o">=</span> <span class="n">_get_raw_feature_spec</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>

  <span class="n">serialized_tf_example</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span>
      <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;input_example_tensor&#39;</span><span class="p">)</span>

  <span class="c1"># Add a parse_example operator to the tensorflow graph, which will parse</span>
  <span class="c1"># raw, untransformed, tf examples.</span>
  <span class="n">features</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">parse_example</span><span class="p">(</span>
      <span class="n">serialized</span><span class="o">=</span><span class="n">serialized_tf_example</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">raw_feature_spec</span><span class="p">)</span>

  <span class="n">transformed_features</span> <span class="o">=</span> <span class="n">tf_transform_output</span><span class="o">.</span><span class="n">transform_raw_features</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
  <span class="n">labels</span> <span class="o">=</span> <span class="n">transformed_features</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">transformed_name</span><span class="p">(</span><span class="n">LABEL_KEY</span><span class="p">))</span>

  <span class="n">receiver_tensors</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;examples&#39;</span><span class="p">:</span> <span class="n">serialized_tf_example</span><span class="p">}</span>

  <span class="k">return</span> <span class="n">tfma</span><span class="o">.</span><span class="n">export</span><span class="o">.</span><span class="n">EvalInputReceiver</span><span class="p">(</span>
      <span class="n">features</span><span class="o">=</span><span class="n">transformed_features</span><span class="p">,</span>
      <span class="n">receiver_tensors</span><span class="o">=</span><span class="n">receiver_tensors</span><span class="p">,</span>
      <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_input_fn</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="n">tf_transform_output</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Generates features and labels for training or evaluation.</span>

<span class="sd">  Args:</span>
<span class="sd">    filenames: List of CSV files to read data from.</span>
<span class="sd">    tf_transform_output: A TFTransformOutput.</span>
<span class="sd">    batch_size: First dimension size of the Tensors returned by input_fn.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A (features, indices) tuple where features is a dictionary of</span>
<span class="sd">      Tensors, and indices is a single Tensor of label indices.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">transformed_feature_spec</span> <span class="o">=</span> <span class="p">(</span>
      <span class="n">tf_transform_output</span><span class="o">.</span><span class="n">transformed_feature_spec</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

  <span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">make_batched_features_dataset</span><span class="p">(</span>
      <span class="n">filenames</span><span class="p">,</span>
      <span class="n">batch_size</span><span class="p">,</span>
      <span class="n">transformed_feature_spec</span><span class="p">,</span>
      <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
      <span class="n">reader</span><span class="o">=</span><span class="n">_gzip_reader_fn</span><span class="p">)</span>

  <span class="n">transformed_features</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">make_one_shot_iterator</span><span class="p">()</span><span class="o">.</span><span class="n">get_next</span><span class="p">()</span>

  <span class="c1"># We pop the label because we do not want to use it as a feature while we&#39;re</span>
  <span class="c1"># training.</span>
  <span class="k">return</span> <span class="n">transformed_features</span><span class="p">,</span> <span class="n">transformed_features</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
      <span class="n">transformed_name</span><span class="p">(</span><span class="n">LABEL_KEY</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_keras_model_builder</span><span class="p">():</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Build a keras model for COMPAS dataset classification.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A compiled Keras model.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">feature_columns</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">feature_layer_inputs</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">transformed_names</span><span class="p">(</span><span class="n">INT_FEATURE_KEYS</span><span class="p">):</span>
    <span class="n">feature_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">numeric_column</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
    <span class="n">feature_layer_inputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">num_buckets</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">transformed_names</span><span class="p">(</span><span class="n">CATEGORICAL_FEATURE_KEYS</span><span class="p">),</span>
                              <span class="n">MAX_CATEGORICAL_FEATURE_VALUES</span><span class="p">):</span>
    <span class="n">feature_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">indicator_column</span><span class="p">(</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">categorical_column_with_identity</span><span class="p">(</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">num_buckets</span><span class="o">=</span><span class="n">num_buckets</span><span class="p">)))</span>
    <span class="n">feature_layer_inputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

  <span class="n">feature_columns_input</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">DenseFeatures</span><span class="p">(</span><span class="n">feature_columns</span><span class="p">)</span>
  <span class="n">feature_layer_outputs</span> <span class="o">=</span> <span class="n">feature_columns_input</span><span class="p">(</span><span class="n">feature_layer_inputs</span><span class="p">)</span>

  <span class="n">dense_layers</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
      <span class="mi">20</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dense_1&#39;</span><span class="p">)(</span><span class="n">feature_layer_outputs</span><span class="p">)</span>
  <span class="n">dense_layers</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
      <span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dense_2&#39;</span><span class="p">)(</span><span class="n">dense_layers</span><span class="p">)</span>
  <span class="n">output</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
      <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;predictions&#39;</span><span class="p">)(</span><span class="n">dense_layers</span><span class="p">)</span>

  <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
      <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">feature_layer_inputs</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="n">outputs</span><span class="o">=</span><span class="n">output</span><span class="p">)</span>

  <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
      <span class="n">loss</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">MeanAbsoluteError</span><span class="p">(),</span>
      <span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">_LEARNING_RATE</span><span class="p">))</span>

  <span class="k">return</span> <span class="n">model</span>


<span class="c1"># TFX will call this function.</span>
<span class="k">def</span> <span class="nf">trainer_fn</span><span class="p">(</span><span class="n">hparams</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Build the estimator using the high level API.</span>

<span class="sd">  Args:</span>
<span class="sd">    hparams: Hyperparameters used to train the model as name/value pairs.</span>
<span class="sd">    schema: Holds the schema of the training examples.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A dict of the following:</span>
<span class="sd">      - estimator: The estimator that will be used for training and eval.</span>
<span class="sd">      - train_spec: Spec for training.</span>
<span class="sd">      - eval_spec: Spec for eval.</span>
<span class="sd">      - eval_input_receiver_fn: Input function for eval.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">tf_transform_output</span> <span class="o">=</span> <span class="n">tft</span><span class="o">.</span><span class="n">TFTransformOutput</span><span class="p">(</span><span class="n">hparams</span><span class="o">.</span><span class="n">transform_output</span><span class="p">)</span>

  <span class="n">train_input_fn</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">_input_fn</span><span class="p">(</span>
      <span class="n">hparams</span><span class="o">.</span><span class="n">train_files</span><span class="p">,</span>
      <span class="n">tf_transform_output</span><span class="p">,</span>
      <span class="n">batch_size</span><span class="o">=</span><span class="n">_BATCH_SIZE</span><span class="p">)</span>

  <span class="n">eval_input_fn</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">_input_fn</span><span class="p">(</span>
      <span class="n">hparams</span><span class="o">.</span><span class="n">eval_files</span><span class="p">,</span>
      <span class="n">tf_transform_output</span><span class="p">,</span>
      <span class="n">batch_size</span><span class="o">=</span><span class="n">_BATCH_SIZE</span><span class="p">)</span>

  <span class="n">train_spec</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">TrainSpec</span><span class="p">(</span>
      <span class="n">train_input_fn</span><span class="p">,</span>
      <span class="n">max_steps</span><span class="o">=</span><span class="n">hparams</span><span class="o">.</span><span class="n">train_steps</span><span class="p">)</span>

  <span class="n">serving_receiver_fn</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">_example_serving_receiver_fn</span><span class="p">(</span>
      <span class="n">tf_transform_output</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>

  <span class="n">exporter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">FinalExporter</span><span class="p">(</span><span class="s1">&#39;compas&#39;</span><span class="p">,</span> <span class="n">serving_receiver_fn</span><span class="p">)</span>
  <span class="n">eval_spec</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">EvalSpec</span><span class="p">(</span>
      <span class="n">eval_input_fn</span><span class="p">,</span>
      <span class="n">steps</span><span class="o">=</span><span class="n">hparams</span><span class="o">.</span><span class="n">eval_steps</span><span class="p">,</span>
      <span class="n">exporters</span><span class="o">=</span><span class="p">[</span><span class="n">exporter</span><span class="p">],</span>
      <span class="n">name</span><span class="o">=</span><span class="s1">&#39;compas-eval&#39;</span><span class="p">)</span>

  <span class="n">run_config</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">RunConfig</span><span class="p">(</span>
      <span class="n">save_checkpoints_steps</span><span class="o">=</span><span class="n">_SAVE_CHECKPOINT_STEPS</span><span class="p">,</span>
      <span class="n">keep_checkpoint_max</span><span class="o">=</span><span class="n">_MAX_CHECKPOINTS</span><span class="p">)</span>

  <span class="n">run_config</span> <span class="o">=</span> <span class="n">run_config</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">model_dir</span><span class="o">=</span><span class="n">hparams</span><span class="o">.</span><span class="n">serving_model_dir</span><span class="p">)</span>

  <span class="n">estimator</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">model_to_estimator</span><span class="p">(</span>
      <span class="n">keras_model</span><span class="o">=</span><span class="n">_keras_model_builder</span><span class="p">(),</span> <span class="n">config</span><span class="o">=</span><span class="n">run_config</span><span class="p">)</span>

  <span class="c1"># Create an input receiver for TFMA processing.</span>
  <span class="n">receiver_fn</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">_eval_input_receiver_fn</span><span class="p">(</span><span class="n">tf_transform_output</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>

  <span class="k">return</span> <span class="p">{</span>
      <span class="s1">&#39;estimator&#39;</span><span class="p">:</span> <span class="n">estimator</span><span class="p">,</span>
      <span class="s1">&#39;train_spec&#39;</span><span class="p">:</span> <span class="n">train_spec</span><span class="p">,</span>
      <span class="s1">&#39;eval_spec&#39;</span><span class="p">:</span> <span class="n">eval_spec</span><span class="p">,</span>
      <span class="s1">&#39;eval_input_receiver_fn&#39;</span><span class="p">:</span> <span class="n">receiver_fn</span>
  <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_pipelie_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;compas&#39;</span><span class="p">,</span> <span class="s1">&#39;pipeline.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> {_pipelie_path}

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">absl</span>
<span class="kn">import</span> <span class="nn">tensorflow_model_analysis</span> <span class="k">as</span> <span class="nn">tfma</span>
<span class="kn">from</span> <span class="nn">tfx</span> <span class="kn">import</span> <span class="n">v1</span> <span class="k">as</span> <span class="n">tfx</span>
<span class="kn">from</span> <span class="nn">tfx.components</span> <span class="kn">import</span> <span class="p">(</span><span class="n">CsvExampleGen</span><span class="p">,</span>
                            <span class="n">Evaluator</span><span class="p">,</span>
                            <span class="n">Pusher</span><span class="p">,</span>
                            <span class="n">SchemaGen</span><span class="p">,</span>
                            <span class="n">StatisticsGen</span><span class="p">,</span>
                            <span class="n">Trainer</span><span class="p">,</span>
                            <span class="n">Transform</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">tfx.components.trainer.executor</span> <span class="kn">import</span> <span class="n">Executor</span>
<span class="kn">from</span> <span class="nn">tfx.dsl.components.base</span> <span class="kn">import</span> <span class="n">executor_spec</span>

<span class="kn">from</span> <span class="nn">tfx.orchestration</span> <span class="kn">import</span> <span class="n">pipeline</span>
<span class="kn">from</span> <span class="nn">tfx.orchestration</span> <span class="kn">import</span> <span class="n">metadata</span>
<span class="kn">from</span> <span class="nn">tfx.proto</span> <span class="kn">import</span> <span class="n">pusher_pb2</span>
<span class="kn">from</span> <span class="nn">tfx.proto</span> <span class="kn">import</span> <span class="n">trainer_pb2</span>
<span class="kn">from</span> <span class="nn">tfx.proto</span> <span class="kn">import</span> <span class="n">example_gen_pb2</span>
<span class="kn">from</span> <span class="nn">tfx.orchestration.local.local_dag_runner</span> <span class="kn">import</span> <span class="n">LocalDagRunner</span>

<span class="n">_pipeline_name</span> <span class="o">=</span> <span class="s1">&#39;compas&#39;</span>
<span class="n">_compas_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;compas&#39;</span><span class="p">)</span>
<span class="n">_data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_compas_root</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span>
<span class="c1"># Python module file to inject customized logic into the TFX components. The</span>
<span class="c1"># Transform and Trainer both require user-defined functions to run successfully.</span>
<span class="n">_transformer_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_compas_root</span><span class="p">,</span> <span class="s1">&#39;transformer.py&#39;</span><span class="p">)</span>
<span class="n">_trainer_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_compas_root</span><span class="p">,</span> <span class="s1">&#39;trainer.py&#39;</span><span class="p">)</span>
<span class="c1"># Path which can be listened to by the model server.  Pusher will output the</span>
<span class="c1"># trained model here.</span>
<span class="n">_serving_model_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_compas_root</span><span class="p">,</span> <span class="s1">&#39;serving_model&#39;</span><span class="p">,</span> <span class="n">_pipeline_name</span><span class="p">)</span>

<span class="c1"># Directory and data locations.  This example assumes all of the chicago taxi</span>
<span class="c1"># example code and metadata library is relative to $HOME, but you can store</span>
<span class="c1"># these files anywhere on your local filesystem.</span>
<span class="n">_tfx_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;compas&#39;</span><span class="p">,</span> <span class="s1">&#39;tfx&#39;</span><span class="p">)</span>
<span class="n">_pipeline_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_tfx_root</span><span class="p">,</span> <span class="s1">&#39;pipelines&#39;</span><span class="p">,</span> <span class="n">_pipeline_name</span><span class="p">)</span>
<span class="c1"># Sqlite ML-metadata db path.</span>
<span class="n">_metadata_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_tfx_root</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="n">_pipeline_name</span><span class="p">,</span>
                              <span class="s1">&#39;metadata.db&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">create_pipeline</span><span class="p">(</span>
    <span class="n">pipeline_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">pipeline_root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">data_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">preprocessing_module_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">trainer_module_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">train_args</span><span class="p">:</span> <span class="n">tfx</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">TrainArgs</span><span class="p">,</span>
    <span class="n">eval_args</span><span class="p">:</span> <span class="n">tfx</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">EvalArgs</span><span class="p">,</span>
    <span class="n">serving_model_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">metadata_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">schema_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tfx</span><span class="o">.</span><span class="n">dsl</span><span class="o">.</span><span class="n">Pipeline</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Implements the compass pipeline with TFX.&quot;&quot;&quot;</span>

  <span class="c1"># Brings data into the pipeline or otherwise joins/converts training data.</span>

  <span class="nb">input</span> <span class="o">=</span> <span class="n">tfx</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">splits</span><span class="o">=</span><span class="p">[</span>
                <span class="n">example_gen_pb2</span><span class="o">.</span><span class="n">Input</span><span class="o">.</span><span class="n">Split</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s1">&#39;train/*&#39;</span><span class="p">),</span>
                <span class="n">example_gen_pb2</span><span class="o">.</span><span class="n">Input</span><span class="o">.</span><span class="n">Split</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;eval&#39;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s1">&#39;eval/*&#39;</span><span class="p">)</span>
            <span class="p">])</span>
  <span class="n">example_gen</span> <span class="o">=</span> <span class="n">CsvExampleGen</span><span class="p">(</span><span class="n">input_base</span><span class="o">=</span><span class="n">data_path</span><span class="p">,</span> <span class="n">input_config</span><span class="o">=</span><span class="nb">input</span><span class="p">)</span>

  <span class="c1"># Computes statistics over data for visualization and example validation.</span>
  <span class="n">statistics_gen</span> <span class="o">=</span> <span class="n">StatisticsGen</span><span class="p">(</span>
      <span class="n">examples</span><span class="o">=</span><span class="n">example_gen</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;examples&#39;</span><span class="p">])</span>

  <span class="k">if</span> <span class="n">schema_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># Generates schema based on statistics files.</span>
    <span class="n">schema_gen</span> <span class="o">=</span> <span class="n">SchemaGen</span><span class="p">(</span>
        <span class="n">statistics</span><span class="o">=</span><span class="n">statistics_gen</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;statistics&#39;</span><span class="p">])</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="c1"># Import user provided schema into the pipeline.</span>
    <span class="n">schema_gen</span> <span class="o">=</span> <span class="n">tfx</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">ImportSchemaGen</span><span class="p">(</span><span class="n">schema_file</span><span class="o">=</span><span class="n">schema_path</span><span class="p">)</span>


  <span class="c1"># Performs transformations and feature engineering in training and serving.</span>
  <span class="n">transform</span> <span class="o">=</span> <span class="n">Transform</span><span class="p">(</span>
      <span class="n">examples</span><span class="o">=</span><span class="n">example_gen</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;examples&#39;</span><span class="p">],</span>
      <span class="n">schema</span><span class="o">=</span><span class="n">schema_gen</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;schema&#39;</span><span class="p">],</span>
      <span class="n">module_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">preprocessing_module_file</span><span class="p">))</span>

  <span class="c1"># Uses user-provided Python function that implements a model.</span>
  <span class="n">trainer_args</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;module_file&#39;</span><span class="p">:</span> <span class="n">trainer_module_file</span><span class="p">,</span>
      <span class="s1">&#39;examples&#39;</span><span class="p">:</span> <span class="n">transform</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;transformed_examples&#39;</span><span class="p">],</span>
      <span class="s1">&#39;schema&#39;</span><span class="p">:</span> <span class="n">schema_gen</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;schema&#39;</span><span class="p">],</span>
      <span class="s1">&#39;custom_executor_spec&#39;</span> <span class="p">:</span> <span class="n">executor_spec</span><span class="o">.</span><span class="n">ExecutorClassSpec</span><span class="p">(</span><span class="n">Executor</span><span class="p">),</span>
      <span class="s1">&#39;transform_graph&#39;</span><span class="p">:</span> <span class="n">transform</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;transform_graph&#39;</span><span class="p">],</span>
      <span class="s1">&#39;train_args&#39;</span><span class="p">:</span> <span class="n">train_args</span><span class="p">,</span>
      <span class="s1">&#39;eval_args&#39;</span><span class="p">:</span> <span class="n">eval_args</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="o">**</span><span class="n">trainer_args</span><span class="p">)</span>

  <span class="c1"># Uses TFMA to compute a evaluation statistics over features of a model and</span>
  <span class="c1"># perform quality validation of a candidate model (compared to a baseline).</span>
  <span class="n">eval_config</span> <span class="o">=</span> <span class="n">tfma</span><span class="o">.</span><span class="n">EvalConfig</span><span class="p">(</span>
      <span class="n">model_specs</span><span class="o">=</span><span class="p">[</span>
          <span class="n">tfma</span><span class="o">.</span><span class="n">ModelSpec</span><span class="p">(</span>
              <span class="n">label_key</span><span class="o">=</span><span class="s1">&#39;is_recid&#39;</span><span class="p">)</span>
      <span class="p">],</span>
      <span class="n">slicing_specs</span><span class="o">=</span><span class="p">[</span>
          <span class="n">tfma</span><span class="o">.</span><span class="n">SlicingSpec</span><span class="p">(</span>
              <span class="n">feature_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;race&#39;</span><span class="p">])</span>
      <span class="p">],</span>
      <span class="n">metrics_specs</span><span class="o">=</span><span class="p">[</span>
          <span class="n">tfma</span><span class="o">.</span><span class="n">MetricsSpec</span><span class="p">(</span><span class="n">metrics</span><span class="o">=</span><span class="p">[</span>
              <span class="n">tfma</span><span class="o">.</span><span class="n">MetricConfig</span><span class="p">(</span>
                  <span class="n">class_name</span><span class="o">=</span><span class="s1">&#39;BinaryAccuracy&#39;</span><span class="p">),</span>
              <span class="n">tfma</span><span class="o">.</span><span class="n">MetricConfig</span><span class="p">(</span>
                  <span class="n">class_name</span><span class="o">=</span><span class="s1">&#39;AUC&#39;</span><span class="p">),</span>
              <span class="n">tfma</span><span class="o">.</span><span class="n">MetricConfig</span><span class="p">(</span>
                  <span class="n">class_name</span><span class="o">=</span><span class="s1">&#39;FairnessIndicators&#39;</span><span class="p">,</span>
                  <span class="n">config</span><span class="o">=</span><span class="s1">&#39;{&quot;thresholds&quot;: [0.25, 0.5, 0.75]}&#39;</span><span class="p">)</span>

          <span class="p">])</span>
      <span class="p">])</span>
  <span class="n">evaluator</span> <span class="o">=</span> <span class="n">Evaluator</span><span class="p">(</span><span class="n">examples</span><span class="o">=</span><span class="n">example_gen</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;examples&#39;</span><span class="p">],</span>
                        <span class="n">model</span><span class="o">=</span><span class="n">trainer</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
                        <span class="n">eval_config</span><span class="o">=</span><span class="n">eval_config</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">Pipeline</span><span class="p">(</span>
      <span class="n">pipeline_name</span><span class="o">=</span><span class="n">pipeline_name</span><span class="p">,</span>
      <span class="n">pipeline_root</span><span class="o">=</span><span class="n">pipeline_root</span><span class="p">,</span>
      <span class="n">components</span><span class="o">=</span><span class="p">[</span>
          <span class="n">example_gen</span><span class="p">,</span>
          <span class="n">statistics_gen</span><span class="p">,</span>
          <span class="n">schema_gen</span><span class="p">,</span>
          <span class="n">transform</span><span class="p">,</span>
          <span class="n">trainer</span><span class="p">,</span>
          <span class="n">evaluator</span><span class="p">,</span>
      <span class="p">],</span>
      <span class="n">metadata_connection_config</span><span class="o">=</span><span class="n">metadata</span><span class="o">.</span><span class="n">sqlite_metadata_connection_config</span><span class="p">(</span>
          <span class="n">metadata_path</span><span class="p">)</span>
  <span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
  <span class="n">absl</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity</span><span class="p">(</span><span class="n">absl</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

  <span class="n">LocalDagRunner</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
      <span class="n">create_pipeline</span><span class="p">(</span>
          <span class="n">pipeline_name</span><span class="o">=</span><span class="n">_pipeline_name</span><span class="p">,</span>
          <span class="n">pipeline_root</span><span class="o">=</span><span class="n">_pipeline_root</span><span class="p">,</span>
          <span class="n">data_path</span><span class="o">=</span><span class="n">_data_path</span><span class="p">,</span>
          <span class="n">preprocessing_module_file</span><span class="o">=</span> <span class="n">_transformer_file</span><span class="p">,</span>
          <span class="n">trainer_module_file</span><span class="o">=</span><span class="n">_trainer_file</span><span class="p">,</span>
          <span class="n">serving_model_dir</span><span class="o">=</span><span class="n">_serving_model_dir</span><span class="p">,</span>
          <span class="n">metadata_path</span><span class="o">=</span><span class="n">_metadata_path</span><span class="p">,</span>
          <span class="n">train_args</span><span class="o">=</span><span class="n">trainer_pb2</span><span class="o">.</span><span class="n">TrainArgs</span><span class="p">(</span><span class="n">num_steps</span><span class="o">=</span><span class="mi">10000</span><span class="p">),</span>
          <span class="n">eval_args</span><span class="o">=</span><span class="n">trainer_pb2</span><span class="o">.</span><span class="n">EvalArgs</span><span class="p">(</span><span class="n">num_steps</span><span class="o">=</span><span class="mi">5000</span><span class="p">))</span>
  <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span><span class="o">{</span>_pipelie_path<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ml_metadata.metadata_store</span> <span class="kn">import</span> <span class="n">metadata_store</span>
<span class="kn">from</span> <span class="nn">ml_metadata.proto</span> <span class="kn">import</span> <span class="n">metadata_store_pb2</span>

<span class="n">connection_config</span> <span class="o">=</span> <span class="n">metadata_store_pb2</span><span class="o">.</span><span class="n">ConnectionConfig</span><span class="p">()</span>
<span class="n">connection_config</span><span class="o">.</span><span class="n">sqlite</span><span class="o">.</span><span class="n">filename_uri</span> <span class="o">=</span> <span class="s1">&#39;./compas/tfx/metadata/compas/metadata.db&#39;</span>
<span class="n">connection_config</span><span class="o">.</span><span class="n">sqlite</span><span class="o">.</span><span class="n">connection_mode</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># READWRITE_OPENCREATE</span>
<span class="n">store</span> <span class="o">=</span> <span class="n">metadata_store</span><span class="o">.</span><span class="n">MetadataStore</span><span class="p">(</span><span class="n">connection_config</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">get_artifacts_by_type</span><span class="p">(</span><span class="s2">&quot;Examples&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uri</span>
<span class="n">evaluator</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">get_artifacts_by_type</span><span class="p">(</span><span class="s2">&quot;ModelEvaluation&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">uri</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">get_artifacts_by_type</span><span class="p">(</span><span class="s2">&quot;Model&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">uri</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;Format-Serving&#39;</span><span class="p">)</span>
<span class="n">_data_paths</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;eval&#39;</span><span class="p">:</span> <span class="n">TensorflowDataset</span><span class="p">(</span><span class="n">dataset_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;Split-eval&#39;</span><span class="p">,</span> <span class="s1">&#39;*.gz&#39;</span><span class="p">)),</span>
               <span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="n">TensorflowDataset</span><span class="p">(</span><span class="n">dataset_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;Split-train&#39;</span><span class="p">,</span> <span class="s1">&#39;*.gz&#39;</span><span class="p">))}</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_project_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;compas&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_eval_config</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_project_path</span><span class="p">,</span> <span class="s1">&#39;eval_config.proto&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> {_eval_config}

<span class="n">model_specs</span> <span class="p">{</span>
    <span class="n">label_key</span><span class="p">:</span> <span class="s1">&#39;is_recid&#39;</span>
  <span class="p">}</span>
<span class="n">metrics_specs</span> <span class="p">{</span>
    <span class="n">metrics</span> <span class="p">{</span><span class="n">class_name</span><span class="p">:</span> <span class="s2">&quot;BinaryAccuracy&quot;</span><span class="p">}</span>
    <span class="n">metrics</span> <span class="p">{</span><span class="n">class_name</span><span class="p">:</span> <span class="s2">&quot;AUC&quot;</span><span class="p">}</span>
    <span class="n">metrics</span> <span class="p">{</span><span class="n">class_name</span><span class="p">:</span> <span class="s2">&quot;ConfusionMatrixPlot&quot;</span><span class="p">}</span>
    <span class="n">metrics</span> <span class="p">{</span>
      <span class="n">class_name</span><span class="p">:</span> <span class="s2">&quot;FairnessIndicators&quot;</span>
      <span class="n">config</span><span class="p">:</span> <span class="s1">&#39;{&quot;thresholds&quot;: [0.25, 0.5, 0.75]}&#39;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="n">slicing_specs</span> <span class="p">{}</span>
<span class="n">slicing_specs</span> <span class="p">{</span>
        <span class="n">feature_keys</span><span class="p">:</span> <span class="s1">&#39;race&#39;</span>
  <span class="p">}</span>
<span class="n">options</span> <span class="p">{</span>
    <span class="n">include_default_metrics</span> <span class="p">{</span> <span class="n">value</span><span class="p">:</span> <span class="n">false</span> <span class="p">}</span>
  <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">overview</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;COMPAS (Correctional Offender Management Profiling for Alternative Sanctions)&quot;</span>
<span class="s2">&quot; is a public dataset, which contains approximately 18,000 criminal cases from &quot;</span>
<span class="s2">&quot;Broward County, Florida between January, 2013 and December, 2014. The data contains&quot;</span>
<span class="s2">&quot; information about 11,000 unique defendants, including criminal history demographics,&quot;</span>
<span class="s2">&quot; and a risk score intended to represent the defendant’s likelihood of reoffending&quot;</span>
<span class="s2">&quot; (recidivism). A machine learning model trained on this data has been used by judges&quot;</span>
<span class="s2">&quot; and parole officers to determine whether or not to set bail and whether or not to&quot;</span>
<span class="s2">&quot; grant parole.&quot;</span>

<span class="s2">&quot;In 2016, an article published in ProPublica found that the COMPAS model was incorrectly&quot;</span>
<span class="s2">&quot; predicting that African-American defendants would recidivate at much higher rates than&quot;</span>
<span class="s2">&quot; their white counterparts while Caucasian would not recidivate at a much higher rate. &quot;</span>
<span class="s2">&quot;For Caucasian defendants, the model made mistakes in the opposite direction, making incorrect predictions &quot;</span>
<span class="s2">&quot;that they wouldn’t commit another crime. The authors went on to show that these biases were likely due to &quot;</span>
<span class="s2">&quot;an uneven distribution in the data between African-Americans and Caucasian defendants. Specifically, the &quot;</span>
<span class="s2">&quot;ground truth label of a negative example (a defendant would not commit another crime) and a positive example &quot;</span>
<span class="s2">&quot;(defendant would commit another crime) were disproportionate between the two races. &quot;</span>
<span class="s2">&quot;Since 2016, the COMPAS dataset has appeared frequently in the ML fairness literature &quot;</span>
<span class="s2">&quot;1, 2, 3, with researchers using it to demonstrate techniques for identifying and remediating &quot;</span>
<span class="s2">&quot;fairness concerns.&quot;</span>

<span class="s2">&quot;It is important to note that developing a machine learning model to predict pre-trial detention &quot;</span>
<span class="s2">&quot;has a number of important ethical considerations. You can learn more about these issues in the &quot;</span>
<span class="s2">&quot;Partnership on AI Report on Algorithmic Risk Assessment Tools in the U.S. Criminal Justice System.&quot;</span>
<span class="s2">&quot; The Partnership on AI is a multi-stakeholder organization -- of which Google is a member -- that &quot;</span>
<span class="s2">&quot;creates guidelines around AI.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mc</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">&quot;model_details&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;COMPAS (Correctional Offender Management Profiling for Alternative Sanctions)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;overview&quot;</span><span class="p">:</span> <span class="n">overview</span><span class="p">,</span>
    <span class="s2">&quot;owners&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Intel XAI Team&quot;</span><span class="p">,</span>
        <span class="s2">&quot;contact&quot;</span><span class="p">:</span> <span class="s2">&quot;xai@intel.com&quot;</span>
      <span class="p">}</span>
    <span class="p">],</span>
    <span class="s2">&quot;references&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s2">&quot;reference&quot;</span><span class="p">:</span> <span class="s2">&quot;Wadsworth, C., Vera, F., Piech, C. (2017). Achieving Fairness Through Adversarial Learning: an Application to Recidivism Prediction. https://arxiv.org/abs/1807.00199.&quot;</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;reference&quot;</span><span class="p">:</span> <span class="s2">&quot;Chouldechova, A., G&#39;Sell, M., (2017). Fairer and more accurate, but for whom? https://arxiv.org/abs/1707.00046.&quot;</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;reference&quot;</span><span class="p">:</span> <span class="s2">&quot;Berk et al., (2017), Fairness in Criminal Justice Risk Assessments: The State of the Art, https://arxiv.org/abs/1703.09207.&quot;</span>
      <span class="p">}</span>
    <span class="p">],</span>
    <span class="s2">&quot;graphics&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s2">&quot;quantitative_analysis&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;graphics&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s2">&quot;schema_version&quot;</span><span class="p">:</span> <span class="s2">&quot;0.0.1&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mcg</span> <span class="o">=</span> <span class="n">ModelCardGen</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">data_sets</span><span class="o">=</span><span class="n">_data_paths</span><span class="p">,</span>
                            <span class="n">eval_config</span><span class="o">=</span><span class="n">_eval_config</span><span class="p">,</span>
                            <span class="n">model_path</span><span class="o">=</span><span class="n">_model_path</span><span class="p">,</span>
                            <span class="n">model_card</span><span class="o">=</span><span class="n">mc</span><span class="p">)</span>
</pre></div>
</div>
</div>
<section id="Display-Model-Card">
<h2>Display Model Card<a class="headerlink" href="#Display-Model-Card" title="Permalink to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mcg</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mcg</span><span class="o">.</span><span class="n">export_html</span><span class="p">(</span><span class="s1">&#39;compas_plotly.html&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Intel.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>